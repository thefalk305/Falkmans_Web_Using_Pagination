<!DOCTYPE html>
<html lang="en">
<head>
  <title>Falkman Family History</title>
  <meta content="Falkman family history site." name="description" />
  <meta content="family history, ancestors, family, parents, grand parents, aunts & uncles, sibling, brothers & sisters, great-grandparents, cousins" name="keywords" />
  <meta content="text/html; charset=iso-8859-1" http-equiv="Content-Type" />
  <meta content="en-us" http-equiv="Content-Language" />
  <meta content="Allen Falkman" name="author"/>
  <meta content="General" name="rating" />
  <meta content="no" http-equiv="imagetoolbar" />
  <meta content="Copyright Â© 2025, Allen Falkman All Rights Reserved" name="copyright" />
  <meta name="page-title" content="Genealogy Document Archive" />
  <link rel="icon" href="../assets/favicon.ico">

  <link href="../css/magnify.css" rel="stylesheet" type="text/css" />
  <link href="../css/records.css" rel="stylesheet" type="text/css" />
</head>
<body>
  <div id="container">
    <div id="header"></div>
    <script src="../js/loadHeader.js"></script>

    <h3 id="doc-notes" style="margin-bottom: 1em;"></h3>

    <div id="form-container" style="display: none;">
      <form id="doc-form" class="styled-form">
        <fieldset>
          <legend>Add New Document</legend>
          <h3>This form facilitates adding a new document to the Document Archives. Fill in the Title and Notes with the appropriate information. Choose a document image from the 'records' folder.  Position and size the red box around the area of interest in the document. The 'Submit' button will copy all the form information to the clipboard which can then be pasted into the records.json file. Remember to assign a sequential 'id' when pasting the new document information into records.json.</h3>
          <div class="form-row">
            <label for="title">Title:</label>
            <input type="text" id="title" />
          </div>

          <div class="form-row">
            <label for="fileInput">File Path:</label>
            <input type="file" id="fileInput" />
          </div>

          <div class="form-row percent-group">
            <div class="percent-pair">
              <label for="xPercent">xPercent:</label>
              <input type="number" id="xPercent" />
            </div>
            <div class="percent-pair">
              <label for="yPercent">yPercent:</label>
              <input type="number" id="yPercent" />
            </div>
            <div class="percent-pair">
              <label for="widthPercent">widthPercent:</label>
              <input type="number" id="widthPercent" />
            </div>
            <div class="percent-pair">
              <label for="heightPercent">heightPercent:</label>
              <input type="number" id="heightPercent" />
            </div>
          </div>          
          
          <div class="form-row">
            <label for="notes">Notes:</label>
            <textarea id="notes" rows="4" cols="80"></textarea>
          </div>

          <div class="form-actions">
            <button type="button" id="submitBtn">Submit</button>
          </div>
        </fieldset>
      </form>    
    </div> 
      <div class="doc-container">
      <div class="img-magnifier-container">
        <img id="doc-image" class="magImage" src="" alt="Document" style="width: 100%;" />
      </div>
      <div id="highlight" class="highlight-box"></div>
    </div>


    <div id="footer"></div>
    <script src="../js/loadFooter.js"></script>
  </div>

<script type="module">
  import { initMagnifierControls } from '../js/magnifier.js';

  const params = new URLSearchParams(window.location.search);
  const isEditMode = params.get('mode') === 'edit';
  const docId = params.get('id');

  const formContainer = document.getElementById('form-container');
  formContainer.style.display = isEditMode ? 'block' : 'none';

  const img = document.getElementById('doc-image');
  const box = document.getElementById('highlight');
  const notesEl = document.getElementById('doc-notes');

  // Load document from records.json if id is present
  if (docId) {
    fetch('../data/records.json')
      .then(res => res.json())
      .then(data => {
      let foundDoc = null;

      for (const person of data) {
        foundDoc = person.documents.find(doc => doc.id === docId);
        if (foundDoc) break;
      }

      if (!foundDoc) {
        notesEl.textContent = 'Document not found.';
        return;
      }

      const { file, highlight, notes } = foundDoc;

      img.src = file;
      notesEl.textContent = notes;

      function updateHighlightBox() {
        box.style.left = `${highlight.xPercent}%`;
        box.style.top = `${highlight.yPercent}%`;
        box.style.width = `${highlight.widthPercent}%`;
        box.style.height = `${highlight.heightPercent}%`;
      }

      img.onload = () => {
        updateHighlightBox();
        initMagnifierControls();
      };

      window.addEventListener('resize', updateHighlightBox);
    })
    .catch(err => {
      notesEl.textContent = 'Error loading document data.';
      console.error('Failed to load records.json:', err);
    });
  }

  // Form logic only runs in edit mode
  if (isEditMode) {
    // Live update box when percent inputs change
    const percentFields = ['xPercent', 'yPercent', 'widthPercent', 'heightPercent'];
    percentFields.forEach(id => {
      document.getElementById(id).addEventListener('input', () => {
        const x = parseFloat(document.getElementById('xPercent').value) || 0;
        const y = parseFloat(document.getElementById('yPercent').value) || 0;
        const w = parseFloat(document.getElementById('widthPercent').value) || 0;
        const h = parseFloat(document.getElementById('heightPercent').value) || 0;

        const imgWidth = img.clientWidth;
        const imgHeight = img.clientHeight;

        const boxX = (x / 100) * imgWidth;
        const boxY = (y / 100) * imgHeight;
        const boxW = (w / 100) * imgWidth;
        const boxH = (h / 100) * imgHeight;

        box.style.left = `${boxX}px`;
        box.style.top = `${boxY}px`;
        box.style.width = `${boxW}px`;
        box.style.height = `${boxH}px`;
      });
    });

    // Copy JSON to clipboard on submit
    document.getElementById('submitBtn').addEventListener('click', () => {
      const fileInput = document.getElementById('fileInput');
      const filename = fileInput.files[0]?.name || '';

      const doc = {
        id: "9999",
        title: document.getElementById('title').value,
        file: `../records/${filename}`,
        highlight: {xPercent: parseFloat(document.getElementById('xPercent').value),yPercent: parseFloat(document.getElementById('yPercent').value), widthPercent: parseFloat(document.getElementById('widthPercent').value),heightPercent: parseFloat(document.getElementById('heightPercent').value) },
        notes: document.getElementById('notes').value
      };

      const jsonText = JSON.stringify(doc, null, 2);
      navigator.clipboard.writeText(jsonText)
        .then(() => alert("Document JSON copied to clipboard!"))
        .catch(err => alert("Failed to copy: " + err));
    });

    // Preview image when file is selected
    document.getElementById('fileInput').addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        img.src = url;
        notesEl.textContent = document.getElementById('notes').value;
        initMagnifierControls();
      }
    });
  }
</script>
<script type="module">
  import { initMagnifierControls } from '../js/magnifier.js';
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
      initMagnifierControls();
    }, 100);
  });
</script>

</body>
</html>