<!DOCTYPE html>
<html lang="en">
<head>
  <title>Falkman Family History</title>
  <meta content="Falkman family history site." name="description" />
  <meta content="family history, ancestors, family, parents, grand parents, aunts & uncles, sibling, brothers & sisters, great-grandparents, cousins" name="keywords" />
  <meta content="text/html; charset=iso-8859-1" http-equiv="Content-Type" />
  <meta content="en-us" http-equiv="Content-Language" />
  <meta content="Allen Falkman" name="author"/>
  <meta content="General" name="rating" />
  <meta content="no" http-equiv="imagetoolbar" />
  <meta content="Copyright Â© 2025, Allen Falkman All Rights Reserved" name="copyright" />
  <meta name="page-title" content="Genealogy Document Archives" />
  <link rel="icon" href="../assets/favicon.ico">

	<link href="../css/font-awesome-7.0.1-all.min.css" rel="stylesheet" type="text/css" />

  <link href="../css/collage.css" rel="stylesheet" type="text/css" />
  <link href="../css/magnify.css" rel="stylesheet" type="text/css" />
  <link href="../css/records.css" rel="stylesheet" type="text/css" />

<style>
.highlight-box.area {
  border-color: rgba(255, 0, 0, 0.5) !important; 
  background-color: rgba(255, 255, 0, 0.0) !important; 
}
</style>

</head>
<body>
  <div id="container">
    <div id="header"></div>
    <script src="../js/loadHeader.js"></script>

    <h3 id="doc-notes" ></h3>
    <!-- This form is used to add more records to the archive -->
    <div id="form-container" style="display: none;">
      <form id="doc-form" class="styled-form">
        <fieldset>
          <legend>Instructions for adding a new document to the Document Archives: </legend>
          <ul style="width: 90%;">
            <li>Fill in the Title, Notes and Caption with the appropriate information.</li>
            <li>Choose a document image from the 'records' folder</li>
            <li>Position and size the <span style="color: red;">red box </span> around the area of interest in the document.</li>
            <p style="margin: 0.2em;" >Note: The <span style="color: red;">red box </span> will move as you click the <i class="fa-solid fa-arrows-up-down"></i> arrows to adjust it's size and position.</p>
            <li>Click the <span style="font-weight: bold;">'Submit' </span>  button when all fields are filled in.  This action will copy the form data to the clipboard.</li>
            <li>The formatted data can then be pasted into the records.json file. Remember to assign sequential 'id's when pasting the new document information into records.json.</li>
          </ul>          
          <div class="form-row">
            <label for="title">Title:</label>
            <input type="text" id="title" />
          </div>

          <div class="form-row">
            <label for="fileInput">File Path:</label>
            <input type="file" id="fileInput" />
          </div>

          <div class="form-row percent-group">
            <div class="percent-pair">
              <label for="x">x:</label>
              <input type="number" id="x" value="5">
            </div>
            <div class="percent-pair">
              <label for="y">y:</label>
              <input type="number" id="y" value="10" />
            </div>
            <div class="percent-pair">
              <label for="width">width:</label>
              <input type="number" id="width" value="20" />
            </div>
            <div class="percent-pair">
              <label for="height">height:</label>
              <input type="number" id="height" value="10" />
            </div>
          </div>          
          
          <div class="form-row">
            <label for="notes">Notes:</label>
            <textarea id="notes" rows="2" cols="80"></textarea>
          </div>

          <div class="form-row">
            <label for="caption">Caption:</label>
            <textarea id="caption" rows="2" cols="80"></textarea>
          </div>

          <div class="form-actions">
            <button type="button" id="submitBtn">Submit</button>
          </div>
        </fieldset>
      </form>    
    </div>
    <div id="doc-container">
      <div class="magGlass-container">
        <img id="doc-image" src="" alt="Document" style="width: 100%;" />
      <div id="highlight" class="highlight-box"></div>
      </div>
    </div>

    <div id="footer"></div>
    <script src="../js/loadFooter.js"></script>
  </div>


<script type="module">
  import { createAreas } from '../js/create-areas.js';

  const params = new URLSearchParams(window.location.search);
  const img = document.getElementById('doc-image');
  const notesEl = document.getElementById('doc-notes');
  const box = document.getElementById('highlight');

  // Form logic only runs in edit mode
  if (params.get('mode') === 'edit') {

    document.getElementById('form-container').style.display = 'block'
    function updateHighlightBoxFromInputs() {
      const x = parseFloat(document.getElementById('x').value) || 20;
      const y = parseFloat(document.getElementById('y').value) || 20;
      const w = parseFloat(document.getElementById('width').value) || 20;
      const h = parseFloat(document.getElementById('height').value) || 10;

      const imgWidth = img.clientWidth;
      const imgHeight = img.clientHeight;
      const boxX = (x / 100) * imgWidth;
      const boxY = (y / 100) * imgHeight;
      const boxW = (w / 100) * imgWidth;
      const boxH = (h / 100) * imgHeight;

      box.style.left = `${boxX}px`;
      box.style.top = `${boxY}px`;
      box.style.width = `${boxW}px`;
      box.style.height = `${boxH}px`;
    }

    // Live update box when percent inputs change
    const percentFields = ['x', 'y', 'width', 'height'];
    percentFields.forEach(id => {
      document.getElementById(id).addEventListener('input', () => {

        updateHighlightBoxFromInputs();
      });
    });

    // Copy JSON to clipboard on submit
    document.getElementById('submitBtn').addEventListener('click', () => {
      const fileInput = document.getElementById('fileInput');
      const filename = fileInput.files[0]?.name || '';

      const doc = {
        id: "9999",
        title: document.getElementById('title').value,
        url: `../records/${filename}`,
        areas: {x: parseFloat(document.getElementById('x').value), 
                y: parseFloat(document.getElementById('y').value), 
                width: parseFloat(document.getElementById('width').value), 
                height: parseFloat(document.getElementById('height').value), 
                caption: document.getElementById('caption').value },
                notes: document.getElementById('notes').value
      };

      // format data for records.json file
      const jsonText = `
      { "id": "9999",
        "title": "${doc.title}",
        "url": "${doc.file}",
        "notes": "${doc.notes}"
        "areas": [
          {  
            "id": "area9999",
            "x": ${doc.areas.x}, 
            "y": ${doc.areas.y}, 
            "width": ${doc.areas.width}, 
            "height": ${doc.areas.height}, 
            "caption": ${doc.caption}
            "zoom": 80
          }
        ]
      },`;

      // const jsonText = JSON.stringify(doc, null, 2);
      navigator.clipboard.writeText(jsonText)
        .then(() => alert("Document JSON copied to clipboard!"))
        .catch(err => alert("Failed to copy: " + err));
    });

    // Preview image when file is selected
    document.getElementById('fileInput').addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file) {

        const url = URL.createObjectURL(file);
        img.src = url;
        notesEl.textContent = document.getElementById('notes').value;        

        img.onload = () => {
          setTimeout(() => {
            updateHighlightBoxFromInputs(); // now layout is stable
            initMagnifierControls();
          }, 50); // adjust if needed
        };
      }
    });  
  } else {
    // not edit mode - continue to display record
    const params = new URLSearchParams(window.location.search);
    const docId = params.get('id');
    createAreas(docId, '../data/records.json');
  }
</script>

</body>
</html>

